<!DOCTYPE html>
<html>
<head>
    <title>SagaFeaturesReporting</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",layout:{type:"vbox",align:"stretch"},margin:"5 5 5 5",items:[{xtype:"container",layout:{type:"hbox",align:"stretch"},height:290,items:[{xtype:"container",id:"formCnt",layout:{type:"vbox"},items:[{xtype:"text",text:"Filter chart and grid by Target Release",margin:"0 0 5 0",width:200}]},{xtype:"container",id:"piechartCnt",layout:{type:"vbox",align:"stretch"},width:500,margin:"0 70 0 70"},{xtype:"container",id:"chartCnt",layout:{type:"vbox",align:"stretch"},width:650,margin:"0 100 0 50"}]},{xtype:"container",flex:1,layout:{type:"hbox",align:"stretch"},margin:"30 0 0 0",id:"gridCnt"}],sagaFeatures:null,launch:function(){this._createFilterBox("c_TargetRelease"),this._createFilterBox("ScheduleState"),this.down("#formCnt").add({xtype:"rallybutton",text:"Submit",handler:function(){this._getFilter()},scope:this}),this._createGrid(null)},_getAllChildren:function(){this.childrenLoaded=0,this.childrenToLoad=0;var filterString=Ext.getCmp("ScheduleStateCombobox").getValue()+"",filters=filterString.split(",");_.forEach(this.sagaFeatures,function(sagaFeature){_.contains(filters,sagaFeature.get("ScheduleState"))&&this._getAllChildThings(sagaFeature,sagaFeature)},this);var me=this,timeout=setInterval(function(){console.log("on",me.childrenLoaded,me.childrenToLoad),me.childrenLoaded>=me.childrenToLoad&&(clearTimeout(timeout),me._onDataLoaded())},300)},_getAllChildThings:function(sagaFeature,child){if(child.get("DirectChildrenCount")>0){this.childrenToLoad++;var children=child.getCollection("Children",{fetch:["FormattedID","Name","_ref","ObjectID","Parent","_ItemHierarchy","Iteration","Release","Project","ScheduleState","PlanEstimate"]});children.load({callback:function(data){this.childrenLoaded++,_.forEach(data,function(c){0===c.get("DirectChildrenCount")&&sagaFeature.children.push(c),this._getAllChildThings(sagaFeature,c)},this)},scope:this})}this.childrenToLoad++;var testCases=child.getCollection("TestCases",{fetch:["FormattedID","LastVerdict"]});testCases.load({callback:function(data){_.forEach(data,function(tc){sagaFeature.testCases.push(tc)},this),this.childrenLoaded++},scope:this})},_createFilterBox:function(property){"c_TargetRelease"===property?this.down("#formCnt").add({xtype:"rallyfieldvaluecombobox",id:property+"Combobox",model:"UserStory",multiSelect:!0,field:property,onReady:function(){var items=this.getStore().getRange(),item;_.forEach(items,function(i){return"17.0"===i.get("name")?(item=i,!1):void 0}),this.select(item)}}):this.down("#formCnt").add([{xtype:"text",text:"Filter grid by Schedule State",margin:"0 0 5 0",width:200},{xtype:"rallyfieldvaluecombobox",id:property+"Combobox",model:"UserStory",multiSelect:!0,field:property,onReady:function(){var items=this.getStore().getRange(),item;_.forEach(items,function(i){return"Completed"===i.get("name")?(item=i,!1):void 0}),this.select(item)}}])},_getFilter:function(){this.down("#rollupPieChart")&&this.down("#rollupPieChart").destroy(),this.down("#rollupChart")&&this.down("#rollupChart").destroy(),this.grid.reconfigure(null),this.grid.setLoading(!0);var filter=Ext.create("Rally.data.wsapi.Filter",{property:"c_StoryType",operator:"=",value:"SAGA Feature"});filter=this._checkFilterStatus("c_TargetRelease",filter),void 0===this._myStore?this._makeStore(filter):(this._myStore.clearFilter(!0),this._myStore.filter(filter))},_checkFilterStatus:function(property,filter){for(var filterString=Ext.getCmp(property+"Combobox").getValue()+"",filterArr=filterString.split(","),propertyFilter=Ext.create("Rally.data.wsapi.Filter",{property:property,operator:"=",value:filterArr[0]}),i=1;filterArr.length>i;)propertyFilter=propertyFilter.or({property:property,operator:"=",value:filterArr[i]}),i++;return filter=filter.and(propertyFilter)},_makeStore:function(filter){this._myStore=Ext.create("Rally.data.wsapi.Store",{model:"userstory",autoLoad:!0,showPagingToolbar:!0,limit:1e3,filters:filter,listeners:{load:function(store,data,success){this.sagaFeatures=data;var ids=_.map(data,function(item){return item.children=[],item.testCases=[],item.get("ObjectID")});this._getAllChildren(ids)},scope:this},fetch:["FormattedID","Name","_ref","ObjectID","Owner","Status","Blocked","Project","Children","PlanEstimate","ScheduleState","c_TargetRelease","Tasks","TaskEstimateTotal","TaskRemainingTotal","c_StoryType","c_PriorityBin","TestCases","TestCaseStatus","Description","Iteration","Release","LastVerdict","Ready"]})},_onDataLoaded:function(){var data=this.sagaFeatures,filterString=Ext.getCmp("ScheduleStateCombobox").getValue()+"",filters=filterString.split(","),stories=[];this._totals={totalStories:data.length,totalStoriesDraft:0,totalStoriesDefined:0,totalStoriesInProgress:0,totalStoriesCompleted:0,totalStoriesAccepted:0,totalStoriesCA:0,totalPointsAccepted:0,totalStoriesEstimated:0,totalPointsEstimated:0,totalStoriesScheduled:0,totalPlannedHours:0,totalHoursRemaining:0,totalHoursCompleted:0},Ext.Array.each(data,function(story){var s={FormattedID:story.get("FormattedID"),Name:story.get("Name"),_ref:story.get("_ref"),Ready:story.get("Ready"),Owner:story.get("Owner")&&story.get("Owner")._refObjectName||"No Owner",Project:story.get("Project").Name,PlanEstimate:story.get("PlanEstimate")||0,ScheduleState:story.get("ScheduleState"),Blocked:story.get("Blocked"),TargetRelease:story.get("c_TargetRelease"),PriorityBin:story.get("c_PriorityBin"),ChildrenCount:story.get("DirectChildrenCount"),TaskEstimateTotal:story.get("TaskEstimateTotal"),TaskRemainingTotal:story.get("TaskRemainingTotal"),TestCaseCount:"EEK",TestCaseStatus:"EEK",Children:[],TestCases:story.testCases,Points:[],TaskCompletedTotal:0,CApts:0,CAhrs:0,Percentage:0,hPercentage:0};switch(s.TaskCompletedTotal=s.TaskEstimateTotal-s.TaskRemainingTotal,s.ScheduleState){case"Draft":this._totals.totalStoriesDraft++;break;case"Defined":this._totals.totalStoriesDefined++;break;case"In-Progress":this._totals.totalStoriesInProgress++;break;case"Completed":this._totals.totalStoriesCompleted++;break;case"Accepted":this._totals.totalStoriesAccepted++}("Accepted"===s.ScheduleState||"Completed"===s.ScheduleState)&&(this._totals.totalStoriesCA++,this._totals.totalPointsAccepted+=s.PlanEstimate),0!==s.PlanEstimate&&this._totals.totalStoriesEstimated++,this._totals.totalPlannedHours+=story.get("TaskEstimateTotal"),this._totals.totalHoursRemaining+=story.get("TaskRemainingTotal"),this._totals.totalHoursCompleted+=this._totals.totalPlannedHours-this._totals.totalHoursRemaining,this._totals.totalPointsEstimated+=s.PlanEstimate,0===s.ChildrenCount&&("Accepted"===s.ScheduleState||"Completed"===s.ScheduleState)&&s.Points.push(s.PlanEstimate),_.forEach(story.children,function(child){var iteration=child.get("Iteration"),release=child.get("Release");s.Children.push({_ref:child.get("_ref"),FormattedID:child.get("FormattedID"),Iteration:iteration&&iteration.Name||"Unscheduled",Release:release&&release.Name||"Unscheduled"}),("Completed"==child.get("ScheduleState")||"Accepted"==child.get("ScheduleState"))&&s.Points.push(child.get("PlanEstimate"))}),s.CApts=_.reduce(s.Points,function(i,acc){return(i||0)+acc},0);var planest=s.PlanEstimate,percent=100*(s.CApts/planest)||0,hpercent=100*(s.TaskCompletedTotal/s.TaskEstimateTotal)||0;s.Percentage=percent.toFixed(2)+"%",s.hPercentage=hpercent.toFixed(2)+"%",_.contains(filters,s.ScheduleState)&&stories.push(s)},this),this._createGrid(stories),window.stories=stories},_createGrid:function(stories){var myCustomStore=Ext.create("Rally.data.custom.Store",{data:stories,pageSize:50});this.grid?(this.grid.reconfigure(myCustomStore),this.down("#dataGrid").setLoading(!1),this._createPieChart(),this._createChart()):this.grid=this.down("#gridCnt").add({xtype:"rallygrid",id:"dataGrid",showPagingToolbar:!0,showRowActionsColumn:!1,editable:!1,flex:1,store:myCustomStore,enableBlockedReasonPopover:!1,columnCfgs:[{xtype:"templatecolumn",text:"ID",dataIndex:"FormattedID",width:80,tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",minWidth:270},{text:"State",dataIndex:"ScheduleState",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.ScheduleStateTemplate",{field:{getAllowedStringValues:function(){return["Draft","Defined","In-Progress","Completed","Accepted"]},name:"ScheduleState"}})},{text:"Priority",dataIndex:"PriorityBin"},{text:"Owner",dataIndex:"Owner"},{text:"Project",dataIndex:"Project"},{text:"T.Release",dataIndex:"TargetRelease",width:70},{text:"Completed Pts / Total Pts (%)",xtype:"templatecolumn",tpl:"{CApts} / {PlanEstimate} ({Percentage})"},{text:"Completed Hrs / Total Hrs (%)",xtype:"templatecolumn",tpl:"{TaskCompletedTotal} / {TaskEstimateTotal} ({hPercentage})"},{text:"Leaf note stories & Iteration & Release Scheduled",dataIndex:"Children",flex:1,renderer:function(value){var html=[];return Ext.Array.each(value,function(child){html.push('<a href="'+Rally.nav.Manager.getDetailUrl(child)+'">'+child.FormattedID+"</a>"+" - "+'<FONT COLOR="#B8860B">'+child.Iteration+"</FONT>"+" - "+child.Release)}),html.join("</br>")}},{text:"TestCases-Verdict",dataIndex:"TestCases",minWidth:160,renderer:function(value){var html=[];return Ext.Array.each(value,function(testcase){html.push('<a href="'+Rally.nav.Manager.getDetailUrl(testcase)+'">'+testcase.get("FormattedID")+"</a>"+"-"+testcase.get("LastVerdict"))}),html.join("</br>")}}]})},_createChart:function(){var chart=this.down("#chartCnt").add({xtype:"rallychart",id:"rollupChart",loadMask:!1,chartConfig:{chart:{type:"column",inverted:!0,height:270},title:{text:"SAGA Feature % Completion"},xAxis:{},yAxis:{min:0,labels:{formatter:function(){return this.value+"%"}},title:{text:null}},tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.y:.0f}</b> ({point.percentage:.0f}%)<br/>',shared:!0},plotOptions:{column:{stacking:"percent"}},legend:{reversed:!0}},chartColors:["#F6A900","#8DC63F"],chartData:{categories:["SAGA Features","Task Hours","Feature Points","# Stories Estimated"],series:[{name:"Remaining",data:[this._totals.totalStories-this._totals.totalStoriesCA,this._totals.totalHoursRemaining,this._totals.totalPointsEstimated-this._totals.totalPointsAccepted,this._totals.totalStories-this._totals.totalStoriesEstimated]},{name:"Completed",data:[this._totals.totalStoriesCA,this._totals.totalPlannedHours-this._totals.totalHoursRemaining,this._totals.totalPointsAccepted,this._totals.totalStoriesEstimated]}]}})},_createPieChart:function(){var pieChart=this.down("#piechartCnt").add({xtype:"rallychart",id:"rollupPieChart",loadMask:!1,chartConfig:{chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,type:"pie",height:285},title:{text:"State of SAGA Features"},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.percentage:.1f} %"}}}},chartData:{series:[{name:"Rolled-up State",colorByPoint:!0,data:[{name:"Draft",y:this._totals.totalStoriesDraft,color:"#cabc91"},{name:"Defined",y:this._totals.totalStoriesDefined,color:"#F6A900"},{name:"In-Progress",y:this._totals.totalStoriesInProgress,color:"#ffe555"},{name:"Completed",y:this._totals.totalStoriesCompleted,color:"#6ecdff"},{name:"Accepted",y:this._totals.totalStoriesAccepted,color:"#8DC63F"}]}]}})}});

            Rally.launchApp('CustomApp', {
                name:"SagaFeaturesReporting",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
